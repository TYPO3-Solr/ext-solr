#!/usr/bin/env bash

PATH_SOLRCONFIG="/var/solr/data/configsets/ext_solr_13_0_0/conf"
PATH_AND_FILENAME_SOLRCONFIG="${PATH_SOLRCONFIG}/solrconfig.xml"

PATH_SOLRXML="/var/solr/data/"
PATH_AND_FILENAME_SOLRXML="${PATH_SOLRXML}/solr.xml"

if grep -q "<lib " "${PATH_AND_FILENAME_SOLRCONFIG}"; then
  echo "The Apache Solr instance is affected on CVE-2025-24814"
  echo "  removing usages of <lib> tags in EXT:solr schemas and moving typo3lib from configset to solr.xml"

  cp "${PATH_AND_FILENAME_SOLRCONFIG}" ${PATH_SOLRCONFIG}/solrconfig.xml.Backup-CVE-2025-24814
  sed -i ':a;N;N;s/.*\<lib .*//g' ${PATH_AND_FILENAME_SOLRCONFIG}

  mv "${PATH_SOLRCONFIG}"/../typo3lib /var/solr/data/.

  cp "${PATH_AND_FILENAME_SOLRXML}" ${PATH_SOLRXML}/solr.xml.Backup-CVE-2025-24814
  # shellcheck disable=SC2016,SC1004
  sed -i 's/<str name="modules">scripting<\/str>/<str name="modules">scripting,analytics,analysis-extras,langid,clustering,extraction,${solr.modules:}<\/str>\
	<str name="allowPaths">${solr.allowPaths:}<\/str>\
	<str name="allowUrls">${solr.allowUrls:}<\/str>\
\
	<!-- TYPO3 Plugins -->\
	<str name="sharedLib">\/var\/solr\/data\/typo3lib\/<\/str>/g' ${PATH_AND_FILENAME_SOLRXML}
fi


